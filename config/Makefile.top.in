#
# Top level Makefile Template for xosview.
#
#
# $Id$
#
include Makefile.config

OBJS = \
llist.o \
Host.o \
xwin.o \
Xrm.o \
defaultstring.o \
meter.o \
fieldmeter.o \
fieldmeterdecay.o \
bitmeter.o \
xosview.o \
main.o

CFILES := $(OBJS:.o=.cc)
DEPFILES := $(OBJS:%=.%.d)

INSTALL            = @INSTALL@

#-----------------------------------------------------------------------

all : meterlib xosview

defaultstring.cc: Xdefaults defresources.awk
	@AWK@ -f defresources.awk Xdefaults > defaultstring.cc

meterlib:
	cd @top_srcdir@/@host_dir@ && $(MAKE)

@top_srcdir@/@host_dir@/libmeter.a: meterlib

##  Also use LDFLAGS, which is inherited from the system.
xosview: $(OBJS) @top_srcdir@/@host_dir@/libmeter.a
	$(CXX) $(LDFLAGS) $(LFLAGS) -o xosview $(OBJS) $(LIBS)

##  If for some reason (such as permissions) you wish to change where
##    xosview is installed, re-run configure with
##    --prefix=<path>, which will change the next line.
PREFIX_TO_USE=@prefix@
BINDIR=$(PREFIX_TO_USE)/bin
MANDIR=$(PREFIX_TO_USE)/man/man1
XAPPLOADDIR=$(PREFIX_TO_USE)/lib/X11/app-defaults

##  These next lines look really ugly.  The echo statements are an
##    attempt to make the output look a little nicer.  The "echo -n"
##    statements create a two-space indent at the beginning of the line.
install: xosview
	@echo "Installing executable..."; echo -n "  "
	@INSTALL_PROGRAM@ @INSTALL_ARGS@ xosview $(BINDIR)
	@echo "Installing application defaults..."; echo -n "  "
	@INSTALL_DATA@ Xdefaults $(XAPPLOADDIR)/XOsview
	@echo "Making sure $(MANDIR) exists..."
	@if [ ! -d $(MANDIR) ]; then \
	  echo "Making $(MANDIR)..."; \
	  mkdir $(MANDIR); \
	fi
	@echo "Installing man page..."; echo -n "  "
	@INSTALL_DATA@ xosview.1 $(MANDIR)

install-man:
	@echo "Use the 'install' target -- it installs the man page, too."
	@#@INSTALL_DATA@ xosview.1 $(MANDIR)

distrib: checksource distclean
	cd @top_srcdir@/..;tar cf `basename $(PWD)`.tar `basename $(PWD)`; \
        gzip -9 `basename $(PWD)`.tar

#  The next one is only used by bgrayson to set up the local
#  mirrors of the xosview distributions.
distrib-and-copy: distrib
	cp ../`basename $(PWD)`.tar.gz ~bgrayson/public_html/xosview
	scp ../`basename $(PWD)`.tar.gz omni:~bgrayson/public_html/xosview

clean :
	cd @host_dir@ && $(MAKE) clean
	@#  Only clean the config directory if it exists...
	sh -c 'if [ -d config ]; then \
	    cd config && $(MAKE) clean; fi'
	rm -f xosview $(OBJS) $(DEPFILES) *~ defaultstring.cc

checksource:
	@#  Check that certain unsafe things aren't in any of the
	@#  code.
	@echo "***  Grep'ing for uses of strcmp, sprintf, strcat, strcmp,"
	@echo "     strcasecmp instead of safer strncmp, snprintf, strncat,"
	@echo "     strncmp, strncasecmp...."
	@#  If egrep finds no matches, it returns as if it is an
	@#  error.  Reverse that error code....
	@sh -c 'egrep "strcmp|sprintf|strcat|strcmp|strcasecmp" \
		*.cc *.h */*.cc */*.h; \
		if [ $$? != 0 ]; then exit 0; else \
		echo "***  Bad functions found -- error!"; exit 1; fi'

distclean: clean
	rm -f Makefile Makefile.config Makefile.GNU.autodep \
           @host_dir@/Makefile config.cache config.log config.status
	@#  Also check _all_ subdirs, not just the configured one, for
	@#  object files.
	sh -c 'objects=`find . -name "*.o" -print`; if [ x$objects != x ]; then \
	  echo "The following object files still need to be removed:";\
	  echo $objects; fi'


maintainer-clean: distclean
	rm -f configure

@AUTODEPEND@
